version: 2.1
jobs:
  build:
    working_directory: ~/repo
    docker:
      - image: circleci/node:12.18.2
    steps:
        - checkout
        - run: 
            name: "Install Java"
            command: |
             "wget --no-cookies --no-check-certificate --header "Cookie: oraclelicense=accept-securebackup-cookie" https://javadl.oracle.com/webapps/download/GetFile/1.8.0_281-b09/89d678f2be164786b292527658ca1605/linux-i586/jdk-8u281-linux-x64.tar.gz",
             "tar -xvf jdk-8u281-linux-x64.tar.gz",
             echo "export JAVA_HOME="/usr/lib/jvm/jdk1.8.0_281" >> $BASH_ENV
        - run: 
            name: "Install Android studio"
            command: |
             "wget http://dl.google.com/android/android-sdk_r24.4-linux.tgz",
             "tar -xvf android-sdk_r24.4-linux.tgz",
             "echo y | ./android-sdk-linux/tools/android update sdk --no-ui --all --filter platform-tools",
             "echo y | ./android-sdk-linux/tools/android update sdk --no-ui --all --filter build-tools-23.0.2",
             "echo y | ./android-sdk-linux/tools/android update sdk --no-ui --all --filter android-23",
             "echo y | ./android-sdk-linux/tools/android update sdk --no-ui --all --filter extra-android-support",
             "echo y | ./android-sdk-linux/tools/android update sdk --no-ui --all --filter extra-android-m2repository",
             "echo y | ./android-sdk-linux/tools/android update sdk --no-ui --all --filter extra-google-m2repository",
             "export ANDROID_HOME=$PWD/android-sdk-linux",
             "export PATH=${PATH}:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/23.0.2",
        - run: 
            name: "Install gradle"
            command: |
              wget https://services.gradle.org/distributions/gradle-4.0.2-bin.zip -P /tmp
              sudo unzip -d /opt/gradle /tmp/gradle-*.zip
              echo 'export GRADLE_HOME=/opt/gradle/gradle-4.0.2' >> $BASH_ENV
              echo 'export PATH=$PATH:/opt/gradle/gradle-4.0.2/bin' >> $BASH_ENV
              source $BASH_ENV
        - run:
            name: "Install ionic and cordova"
            command: |
              sudo npm install -g ionic cordova 
        - run:
            name: "Install npm packages"
            command: |
              npm install
        - run:
            name: "Install Cordova plugins and add android platform"
            command: |
              ionic cordova platform add android --noresources
              ionic config set -g telemetry true
        - run:
            name: "Generate apk"
            command: |
              ionic cordova build android --verbose
              mkdir -p /tmp/apk
              cp -r platforms/android/app/build/outputs/apk/debug/app-debug.apk /tmp/apk
        - store_artifacts:
            path: /tmp/apk
            destination: apks
